<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Language" content="en">
    <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1">
    <title>Chordak Keyboard Layout: One Handed Typing</title>

    <style>
      :root {
        --color-stark: #fff;
        --color-cream: #eee;
        --color-cream-glow: #aaa;
        --color-muted: #444;

        --color-correct: #8eeef6;
        --color-correct-glow: #8eeef6;
        --color-mistake: #e4648a;
        --color-mistake-glow: #e4648a;

        --color-background: #12130f;
        --color-foreground: #1d1e1a;

        --color-paper: #262723;
        --color-type: #e1e1db;

        --key: 5.4rem;
        
        --font-mono: 'Menlo', courier, monospace;
        --font-sans: "Open Sans", courier;
        --font-block: "Open Sans", courier;
        --font-brand: "Open Sans", courier;

        --color-debug-pink: deepPink;
        --color-debug-aqua: Aquamarine;
        --color-debug-coral: Coral;
        --color-debug-gold: Gold;
      }

      ::selection {
        background: #999997; /* WebKit/Blink Browsers */
      }
      ::-moz-selection {
        background: #999997; /* Gecko Browsers */
      }

      html {
        font-size:62.5%; /* 1rem = 10 css pixels */
        background: var(--color-background);
      }

      body {
        width: 100%;
        height: 100%;
        margin:0;
        padding:0;
        background: var(--color-background);
        position: fixed;

        /* essential for mobile safari experience */
        /* -webkit-tap-highlight-color:rgba(0,0,0,0); */
        /* cursor:pointer; */
      }

      /* footer ----------------------------------------------- */
      
      footer {
        /*width: calc(100% - 2.5rem);*/
        width: calc(100% - 2.5rem);
        height: 5.5rem;

        display: flex;
        justify-content: flex-start;

        position: fixed;
        bottom:0;
        margin: 0 2.5rem 2.5rem 0;
          
        border-width: 0 0 0.1rem 0;
        border-style: solid;
        border-color: #222;
        /*background: red;*/
      }

      footer #chordak {
        flex: 0 1 18rem;
        min-width: 14rem;
        position: relative;
        text-align: right;
        background: var(--color-foreground);
        color: var(--color-cream);
      }

      footer #chordak div {
        position: absolute;
        bottom: 0.7rem;
        right: 1rem;
        font-family: var(--font-brand);
        font-size: 2rem;
        line-height: 2rem;
        font-weight: bold;
      }

      footer .menu {
        flex: 0 1 6rem;
        height: 100%;
        position: relative;
        text-decoration: none;
        color: #bbbbb9;
        /*border: 1px solid #111166;*/
      }

      footer .menu img {
        position: absolute;
        top:0.5rem;
        width: 6rem;
        height: 6rem;

      }

      footer .menu div {
        font-family: var(--font-block);
        position: absolute;
        bottom:0.4rem;
        font-size: 1.1rem;
        height: 2rem;
        width: 100%;
        line-height: 2rem;
        text-transform: uppercase;
        text-align: center;
      }

      /* asides ----------------------------------------------- */

      aside {
        width: 22.5rem;
        height: 100%;
        position: fixed;
        top:0;
        z-index: 2;
      }

      aside .inner {
        height: 100%;
        position: absolute;
        background-color: var(--color-foreground);
        overflow: scroll;
      }

      aside .icon {
        width:1.6rem;
        height:1.6rem;
        position: absolute;
        bottom: calc(50% - 0.8rem);
      }

      /* aside left ------------------------------------------- */

      aside.left {
        left: 0;
        transform: translate3d(-17.5rem, 0, 0);
        transition: transform 300ms ease;
      }

      aside.left .inner {
        right: 2.5rem;
        /*width: 20rem;*/
        width: 17rem;
        padding: 0 2.5rem;
        box-shadow: 0.5rem 0 0.5rem -0.15rem black;
        font-family: var(--font-sans);
        font-size: 1.2rem;
        color: var(--color-stark);
        cursor: default;
      }

      aside.left.open {
        transform: translate3d(2rem, 0, 0);
      }

      aside.left .icon {
        right: 2.95rem;
        opacity: 0.8;
        transition: opacity 200ms ease;
      }

      aside.left.open .icon {
        opacity: 0;
      }

      /* aside right ------------------------------------------ */

      aside.right {
        right: 0;
        transform: translate3d(17.5rem, 0, 0);
        transition: transform 300ms ease;
      }

      aside.right .inner {
        left: 2.5rem;
        width: 20rem;
        padding: 0 2.5rem;
        box-shadow: -0.5rem 0 0.5rem -0.15rem black;
      }

      aside.right.open {
        transform: translate3d(-5rem, 0, 0);
      }

      aside.right .icon {
        left: 0.45rem;
        transition: opacity 200ms ease;
        opacity: 0.8;
        /* these lines necessary because this icon is text */
        font-family: var(--font-sans);
        font-size: 1.8rem;
        line-height: 1.6rem;
        color: white;       
      }

      aside.right.open .icon {
        opacity: 0;
      }

      /* main ------------------------------------------------- */

      main {
        width: 100%;
        height: calc(100% - 8rem); /* 8rem is footer height */
        display: flex;
        flex-direction: column;
        justify-content: center; /*flex-start;*/
        align-items: center;
        /*background-color: var(--color-debug-coral);*/
      }

      /* main paper ------------------------------------------- */

      #paper, #blank, #key-info {
        flex: 0 0;
        max-width: 77.2rem; /*max-width: 82.0rem;*/
        padding: 0 1rem 0 1rem;
        width: calc(100% - 12rem);
        height: calc(1.7*1.5rem*3);
        min-height: calc(1.7*1.5rem*3);
        box-shadow: 0rem 0rem 0.5rem 0.2rem black;
        overflow: hidden;
        font-family: var(--font-mono);
        font-size: 1.6rem; /*font-size: 1.7rem;*/
        background-color: var(--color-paper);
        color: var(--color-type);
      }

      #blank {
        outline: none;
        resize: none;
        border: none;
        height: 100%;
        width: calc(100% - 15rem);
        margin: 2.5rem 0;
        padding: 2rem;
        box-shadow: 0rem 0rem 0.5rem 0.4rem black;
        caret-color:white;
        font-size: 1.3rem;
        overflow: scroll;
      }

      #blank.hidden, #paper.hidden {
        display: none;
      }

      #paper .line {
        width: 100%;
        height: calc(1.7rem*1.5);
        color: rgb(221, 221, 221); /*221-238*/
        white-space: nowrap;
      }

      #paper span.c { /* correct */
        color: #48483e;
      }

      #paper span.m { /* mistake */
        color: #e4648a;
      }

      .caret {
        background: #48483e;
        color:#fff;
        /*background-color: #eee;*/
        /*color:#222;*/
        border-radius: 0.1rem;
      }

      .undefined {
        background-color: #e7db75;
        color:#48483e;
        border-radius: 0.1rem;
      }

      /* main keybord ----------------------------------------- */

      #keyboard {
        flex: 0 0;
        min-height: calc(var(--key) * 6);
        width: calc(var(--key) * 8);
        position: relative;
        /*background-color: green;*/
        margin-top: 1rem;

          /*-webkit-user-select: none;*/
          /*-moz-user-select: none;*/
          /*-ms-user-select: none;*/
        user-select: none;
        cursor: default;
      }

      #keyboard.hidden {
        display: none;
      }

      #keyboard .key { 
        border: 0.2rem solid #555; /* REMOVE ABSOLUTE COLOR DECL!!! */
        width: calc(var(--key) - 0.4rem);
        height: calc(var(--key) - 0.4rem);
        border-radius: calc(var(--key) / 2);
        font-size: calc(var(--key) * 0.22);
        font-family: var(--font-sans);
        color: var(--color-cream);
        
        position: absolute;
        /* four line centering */
        display: flex;
        justify-content: center;
        align-items: center;
        text-align: center;
        transition: color 100ms ease, border-color 100ms ease, box-shadow 100ms ease;
      }

      #keyboard .key.editing {
        color:#e7db75;
        border-color: #e7db75;
        box-shadow: 0rem 0rem 1.8rem #e7db75;
      }

      #keyboard .key.pressed {
          -webkit-transform: scale(0.95, 0.95);
          -ms-transform: scale(0.95, 0.95);
        transform: scale(0.95, 0.95);
        color:#FFF;
        border-color: #fff;
        box-shadow: 0rem 0rem 1.8rem #bbb;
      }

      #keyboard .key.pressed-wrong {
          -webkit-transform: scale(0.95, 0.95);
          -ms-transform: scale(0.95, 0.95);
        transform: scale(0.95, 0.95);
        color:#E4648A;
        border-color: #E4648A;
        box-shadow: 0rem 0rem 1.8rem #E4648A;
      }

      #keyboard .key.pressed-correct {
        -webkit-transform: scale(0.95, 0.95);
        -ms-transform: scale(0.95, 0.95);
        transform: scale(0.95, 0.95);
        color:#8EEEF6;
        border-color: #8EEEF6;
        box-shadow: 0rem 0rem 1.8rem #8EEEF6;
      }

      #keyboard .key span {
        font-size: calc(var(--key) * 0.4);
        pointer-events: none;
      }
      #keyboard .key span.stack {
        font-size: calc(var(--key) * 0.3);
        line-height: calc(var(--key) * 0.38);
      }

      #keyboard.L #p0 { top: 28.33%; }
      #keyboard.L #p1 { top: 45.00%; }
      #keyboard.L #p2 { top: 61.67%; }

      #keyboard.L #r0 { top: 10.00%; }
      #keyboard.L #r1 { top: 30.00%; }
      #keyboard.L #r2 { top: 50.00%; }

      #keyboard.L #m0 { top:  3.33%; }
      #keyboard.L #m1 { top: 23.33%; }
      #keyboard.L #m2 { top: 43.33%; }

      #keyboard.L #i0 { top: 10.00%; }
      #keyboard.L #i1 { top: 30.00%; }
      #keyboard.L #i2 { top: 50.00%; }

      #keyboard.L #t0 { top: 81.67%; }
      #keyboard.L #t1 { top: 75.00%; }
      #keyboard.L #t2 { top: 73.33%; }
      #keyboard.L #t3 { top: 76.67%; }

      #keyboard.L #keyboard-title { top:86.67%; }

      /* left handed keyboard layout */
      #keyboard.L #p0 { left:  2.50%; }
      #keyboard.L #p1 { left:  8.75%; }
      #keyboard.L #p2 { left: 15.00%; }

      #keyboard.L #r0 { left: 22.50%; }
      #keyboard.L #r1 { left: 25.00%; }
      #keyboard.L #r2 { left: 27.50%; }

      #keyboard.L #m0 { left: 42.50%; }
      #keyboard.L #m1 { left: 42.50%; }
      #keyboard.L #m2 { left: 42.50%; }

      #keyboard.L #i0 { left: 62.50%; }
      #keyboard.L #i1 { left: 60.00%; }
      #keyboard.L #i2 { left: 57.50%; }

      #keyboard.L #t0 { left: 86.50%; }
      #keyboard.L #t1 { left: 73.25%; }
      #keyboard.L #t2 { left: 59.50%; }
      #keyboard.L #t3 { left: 45.75%; }

      #keyboard.L #keyboard-title { left: 0; }

      /* right handed keyboard layout */
      #keyboard.R #p0 { right:  2.50%; }
      #keyboard.R #p1 { right:  8.75%; }
      #keyboard.R #p2 { right: 15.00%; }

      #keyboard.R #r0 { right: 22.50%; }
      #keyboard.R #r1 { right: 25.00%; }
      #keyboard.R #r2 { right: 27.50%; }

      #keyboard.R #m0 { right: 42.50%; }
      #keyboard.R #m1 { right: 42.50%; }
      #keyboard.R #m2 { right: 42.50%; }

      #keyboard.R #i0 { right: 62.50%; }
      #keyboard.R #i1 { right: 60.00%; }
      #keyboard.R #i2 { right: 57.50%; }

      #keyboard.R #t0 { right: 86.50%; }
      #keyboard.R #t1 { right: 73.25%; }
      #keyboard.R #t2 { right: 59.50%; }
      #keyboard.R #t3 { right: 45.75%; }

      #keyboard.R #keyboard-title { right: 0; }

      /*#p1, #r1, #m1, #i1, #t1 { background-color: #2b2c29; }*/

      #keyboard-title { 
        width: calc(var(--key) * 3.3);
        font-size: calc(var(--key) * 0.26);
        color: var(--color-muted);
        position: absolute;
        text-align: center;
        font-family: var(--font-sans);
        text-transform: uppercase;
        font-weight: bold;
      }

      /* chords legend ---------------------------------------- */

      #nameless {
        width:20rem;
        height:10rem;
        margin: 0.4rem 0 0.6rem 0;
        /*background-color: green;*/
        position: relative;
      }
      #nameless .legend {
        width: 6rem;
        height: 10rem;
      }
      #nameless .legend img {
        width: 6rem;
        height: 100%;
        position: absolute;
        top: 0;
        left: 0;
        opacity: 0.9;
      }

      #nameless .legend div {
        font-family: var(--font-mono);
        font-size: 1.3rem;
        position: absolute;
      }
      #nameless .legend .pinkie {
        top:1.4rem;
        left:0.4rem;
      }
      #nameless .legend .ring {
        top:0.9rem;
        left:1.3rem;
      }
      #nameless .legend .middle {
        top:0.4rem;
        left:2.4rem;
      }
      #nameless .legend .index {
        top:1.2rem;
        left:3.4rem;
      }
      #nameless .legend .thumb {
        top:4.1rem;
        left:5rem;
      }

      #nameless .legend.right img {
        -moz-transform: scaleX(-1);
        -o-transform: scaleX(-1);
        -webkit-transform: scaleX(-1);
        transform: scaleX(-1);
      }
      #nameless .legend.right .pinkie { left:4.8rem; }
      #nameless .legend.right .ring { left:3.7rem; }
      #nameless .legend.right .middle { left:2.8rem; }
      #nameless .legend.right .index { left:1.7rem; }
      #nameless .legend.right .thumb { left:0.1rem; }

      #nameless .info {
        width: 11.5rem;
        height: 8rem;
        padding: 1rem;
        position: absolute;
        top: 0;
        right: 0;
        font-family: var(--font-sans);
        font-size: 1.2rem;
        text-align: left;
        /*background-color: yellow;*/

      }

      /* chords ----------------------------------------------- */


      #chords {
        width: 20rem;
        /*height: calc(100% - 3rem);*/
        /*margin-top: 1.5rem;*/
        /*background-color: var(--color-debug-pink);*/
      }

      #chords div {
        width: 100%;
        display: flex;
        justify-content: space-between;
        font-family: var(--font-mono);
        font-size: 1.3rem;
        border-bottom: 0.1rem solid #444;
      }

      #chords div span {
        width: 3rem;
        height: 1.8rem;
        line-height: 1.8rem;
        height: 100%;
        
        
        text-align: center;
        color: #ddd;
        overflow: hidden;
      }

      #chords div .c {
        text-align: left;
        width: 4.5rem;
        font-style: italic;
        padding-left: 0.5rem;
        order: 1;
      }
      #chords div .l {
        order: 2;
        background-color: #333;
      }
      #chords div .s {
        order: 5;
      }
      #chords div .b {
        order: 4;
      }
      #chords div .n {
        order: 3;
      }

      #chords .header span {
        background-color: #444;
        font-family: var(--font-sans);
        font-size: 1rem;
      }

      #chords .header .c {
        font-style: initial;
        text-align: center;
        padding: 0;
        padding:0 0.25rem;
      }

      /* settings --------------------------------------------- */

      .setting {
        width: 100%;
        height: 3rem;
        padding: 0.5rem 0;
        display: flex;
        align-items: center;
        position: relative;
      }
      
      .setting .hidden {
        display: none;
      }

      .setting :first-child {
        position: absolute;
        left: 0;
      }

      .setting :last-child {
        position: absolute;
        right: 0;
        -webkit-user-select: none;
        user-select: none;
      }

      .switch {
        min-width: 5rem;
        max-width: 5rem;
        height: 2.6rem;
        border:0.2rem solid var(--color-cream);
        border-radius: 1.5rem;
        overflow: hidden;       
        cursor: pointer;
        transition: border-color 0.15s ease;
      }

      .switch .round {
        width: 1.8rem;
        height: 1.8rem;
        position: absolute;
        right: 2.1rem;
        margin: 0.2rem 0.3rem;
        border:0.2rem solid var(--color-mistake);
        border-radius: 50%;
        box-shadow: 0 0 0.9rem var(--color-mistake-glow);
        transition: transform 0.3s ease;
      }

      .setting input:checked+label .round {
        border-color:#8EEEF6;
        box-shadow: 0 0 0.9rem #8EEEF6;
        transform: translate(2.2rem, 0);
      }

      .switch.neutral .round {
        text-align: center; 
        border-color: var(--color-cream);
        box-shadow: 0 0 0.9rem var(--color-cream-glow);
        color: white;
      }

      .setting input:checked+label.neutral .round {
        border-color: var(--color-cream);
        box-shadow: 0 0 0.9rem var(--color-cream-glow);
        transform: translate(2.2rem, 0);
      }

      .setting select {
        height: 3rem;
          -webkit-appearance: none;
        appearance: none;
        outline:none;
        background: none;
        border:0.2rem solid var(--color-cream);
        border-radius: 1.5rem;

        color: #eee;
        text-align: center;
        text-align-last:center;
        font-family: var(--font-sans);
        font-size: 1.1rem;
        padding: 0 1rem 0 1rem;
        cursor: pointer;
      }

      .setting select:focus {
        box-shadow: 0 0 0.9rem var(--color-cream-glow);
      }

      #mode { width: 11rem; }
      #lesson { width: 11rem; }
      #layout { width: 7.5rem; }
      

      .incrementer {
        width:5.4rem;
        height:3.0rem;
        position: relative;
        border-radius:1.5rem;
        background: none;
      }
      
      .incrementer input {
        width: 2.7rem;
        height: 100%;
        position:absolute;
        top:0;
        -webkit-appearance: none;
        appearance: none;
        outline:none;
        background: none;
        border:none;
        font-family: var(--font-mono);
        font-size: 1.4rem;
        text-align: center;
        color: var(--color-stark);
        border:0.2rem solid var(--color-cream);
      }

      .incrementer .left {
        left:0;
        border-width: 0.2rem 0.1rem 0.2rem 0.2rem;
        border-radius: 1.5rem 0 0 1.5rem;
      }

      .incrementer .right {
        right:0;
        border-width: 0.2rem 0.2rem 0.2rem 0.1rem;
        border-radius: 0 1.5rem 1.5rem 0;
      }

      .incrementer input:active {
        box-shadow: 0 0 0.8rem var(--color-cream-glow);
      }

      #reset-button {
        width: 100%;
        height: 3rem;
          -webkit-appearance: none;
        appearance: none;
        outline:none;
        background: none;
        margin: 2rem 0;
        border:0.2rem solid var(--color-mistake-glow);
        border-radius: 1.5rem;
        color: var(--color-mistake);
        font-family: var(--font-sans);
        font-size: 1rem;
        text-transform: uppercase;
      }

      #reset-button:active {
        box-shadow: 0rem 0rem 0.9rem #E4648A;
      }

      hr {
        border: 0.1rem solid var(--color-muted);
      }

      /* layout ----------------------------- */

      #custom-layout {
        margin: 0.5rem 0 1rem 0;
        position: relative;
      }

      #custom-layout .instructions {
        margin-top: 0.5rem;
        /*color: #e7db75;*/
        color:#666;
      }

      #custom-layout ol {
        padding-left: 1.5rem;
        margin:0;
        
        font-size:1.1rem;
      }

      #custom-layout li {
        margin:1rem 0;
      }


      #output {
        position: fixed;
        bottom:0;
        width: calc(100% - 10rem);
        /*margin-bottom: 1rem;*/
        color: #fff;
        font-size: 1.4rem;
        font-family: var(--font-mono);
        background-color: var(--color-debug-pink);
        display: none;
      }

      #warning {
        position: fixed;
        top:0;
        width: 100%;
        padding: 1rem 0;
        color: var(--color-foreground);
        font-size: 1.3rem;
        font-family: var(--font-mono);
        background-color: #e7db75;
        text-align: center;
        opacity: 0;
        transition: none;
        z-index: 3;
      }
      #warning span {
        font-weight: bold;
      }

      #close-button {
        color: red;
      }

/*      @media screen and (max-height: 350px) {
        footer {
          margin-bottom: 1rem;
        }
        #keyboard {
          display:none;
        }
      }*/

      @media screen and (max-height: 320px) {
        #keyboard { display:none; }
      }
    </style>
  </head>


  <body>
    <main>
      <div id="warning">WARNING</div>
      <div id="output">&nbsp;</div>

      <textarea id="blank" class="hidden"></textarea>

      <div id="paper">
        <div id="line-0" class="line">A</div>
        <div id="line-1" class="line">B</div>
        <div id="line-2" class="line">C</div>
        <div id="line-3" class="line">D</div>
        <div id="line-4" class="line">E</div>
      </div>

      <div id="keyboard" class="L">
        <div id="keyboard-title"></div>

        <div id="p0" class="key"></div>
        <div id="p1" class="key"></div>
        <div id="p2" class="key"></div>

        <div id="r0" class="key"></div>
        <div id="r1" class="key"></div>
        <div id="r2" class="key"></div>

        <div id="m0" class="key"></div>
        <div id="m1" class="key"></div>
        <div id="m2" class="key"></div>

        <div id="i0" class="key"></div>
        <div id="i1" class="key"></div>
        <div id="i2" class="key"></div>

        <div id="t0" class="key"></div>
        <div id="t1" class="key"></div>
        <div id="t2" class="key"></div>
        <div id="t3" class="key"></div>
      </div>
    </main>
    
    <aside id="aside-left" class="left">
    <div id="close-button">close</div>
      <div class="inner">
        <br>
        <div class="setting">
          <div>Mode</div>
          <select id="mode" style="width:11rem;">
            <option value="training" selected>Training</option>
            <option value="speed">Speed Test</option>
            <option value="blank">Blank Page</option>
          </select>
        </div>

        <div class="setting">
          <div>Lesson</div>
          <select id="lesson" style="width:11rem;">
            <optgroup label="Alphabet">
              <option value="0">o a t e _</option>
              <option value="1">g v w y</option>
              <option value="2">d f k l</option>
              <option value="3">i p q r</option>
              <option value="4">h n s z</option>
              <option value="5">b c m u</option>
              <option value="6">x&nbsp;&nbsp;j&nbsp;&nbsp;,&nbsp;&nbsp;.</option>
            </optgroup>

            <optgroup label="Alphabet Practice">
              <option value="">Common Bigrams</option>
              <option value="">Common Trigrams</option>
              <option value="">Common Words</option>
              <option value="">Pangrams</option>
              <option value="">abc...</option>
              <option value="">a b c...</option>
              <option value="">Random Letters</option>
              <option value="">Opposite Chords</option>
            </optgroup>

            <optgroup label="Formatting">
              <option value="">Navigation</option>
              <option value="">Return</option>
              <option value="">Tab</option>
            </optgroup>

            <optgroup label="Capitals">
              <option value="">Shift Left</option>
              <option value="">Shift Right</option>
              <option value="">Aa Bb Cc...</option>
              <option value="">Capital Bigrams</option>
              <option value="">Capital Trigrams</option>
              <option value="">Capital Words</option>
              <option value="">Caps Lock</option>
              <option value="">Acronyms</option>
            </optgroup>

            <optgroup label="Numerals">
              <option value="">0 1 2 3</option>
              <option value="">4 7 9</option>
              <option value="">5 8 6</option>
              <option value="">Num Lock*</option>
              <option value="">123...</option>
              <option value="">Random Numbers</option>
              <option value="">Formatted Numbers</option>
              <option value="">Alphanumeric</option>
            </optgroup>

            <optgroup label="Brackets">
              <option value="">( )&nbsp;&nbsp;Round</option>
              <option value="">[ ]&nbsp;&nbsp;Square</option>
              <option value="">{ }&nbsp;&nbsp;Curly</option>
              <option value="">&lt; &gt;&nbsp;&nbsp;Angle</option>
              <option value="">\ /&nbsp;&nbsp;Slashes</option>
              <option value="">|&nbsp;&nbsp;Vertical Bar</option>
            </optgroup>

            <optgroup label="Symbols">
              <option value="">'&nbsp;&nbsp;Apostrophe</option>
              <option value="">"&nbsp;&nbsp;Quotes</option>
              <option value="">;&nbsp;&nbsp;Semicolon</option>
              <option value="">?&nbsp;&nbsp;Question</option>
              <option value="">!&nbsp;&nbsp;Exclamation</option>
              <option value="">_&nbsp;&nbsp;Underscore</option>
              <option value="">:&nbsp;&nbsp;Colon</option>
              <option value="">+&nbsp;&nbsp;Plus Sign</option>
              <option value="">-&nbsp;&nbsp;Hyphen-Minus</option>
              <option value="">=&nbsp;&nbsp;Equals Sign</option>
              <option value="">@&nbsp;&nbsp;At Sign</option>
              <option value="">&amp;&nbsp;&nbsp;Ampersand</option>
              <option value="">*&nbsp;&nbsp;Asterisk</option>
              <option value="">%&nbsp;&nbsp;Percent Sign</option>
              <option value="">#&nbsp;&nbsp;Number Sign</option>
              <option value="">$&nbsp;&nbsp;Dollar Sign</option>
              <option value="">^&nbsp;&nbsp;Caret</option>
              <option value="">~&nbsp;&nbsp;Tilde</option>
              <option value="">`&nbsp;&nbsp;Grave Accent</option>
            </optgroup>

            <optgroup label="Shortcuts">
              <option value="">Command</option>
              <option value="">Option/Alt</option>
              <option value="">Control</option>
              <option value="">Function</option>
              <option value="">Meta</option>
            </optgroup>

            <optgroup label="Advanced Practice">
              <option value="">Math</option>
              <option value="">Programming</option>
              <option value="">Rare Bigrams</option>
              <option value="">Finger Breakers</option>
            </optgroup>
          </select>
        </div>

        <hr>
        
        <div class="setting">
          <div class="description">Typing Hand</div>
          <input class="hidden" id="typing-hand" name="typing-hand" type="checkbox">
          <label for="typing-hand" class="switch neutral"><div id="typing-hand-label" class="round text">L</div></label>
        </div>

        <div class="setting">
          <div>Your Layout</div>
          <select id="layout">
            <option value="qwerty">QWERTY</option>
            <option value="colemak" selected>Colemak</option>
            <option value="dvorak">Dvorak</option>
            <option value="custom">Other...</option>
          </select>
        </div>

        <div id="custom-layout" class="hidden">
          <div class="instructions">
            Custom Layout Instructions
            <ol>
              <li>Click the keyboard twice to switch to the physical view.</li>
              <li>Click and hold on the key you want to modify.</li>
              <li>Type the key you want to use.</li>
            </ol>
          </div>

          <div id="c-p0" class="key"></div>
          <div id="c-p1" class="key"></div>
          <div id="c-p2" class="key"></div>

          <div id="c-r0" class="key"></div>
          <div id="c-r1" class="key"></div>
          <div id="c-r2" class="key"></div>

          <div id="c-m0" class="key"></div>
          <div id="c-m1" class="key"></div>
          <div id="c-m2" class="key"></div>

          <div id="c-i0" class="key"></div>
          <div id="c-i1" class="key"></div>
          <div id="c-i2" class="key"></div>

          <div id="c-t0" class="key"></div>
          <div id="c-t1" class="key"></div>
          <div id="c-t2" class="key"></div>
          <div id="c-t3" class="key"></div>
        </div>

        <div class="setting">
          <div class="description">Simulate Chordak</div>
          <input class="hidden" id="simulate" name="simulate" type="checkbox">
          <label for="simulate" class="switch"><div class="round"></div></label>
        </div>


        <div class="setting">
          <div class="description">Show Keyboard</div>
          <input class="hidden" id="show-keyboard" name="show-keyboard" type="checkbox">
          <label for="show-keyboard" class="switch"><div class="round"></div></label>
        </div>

        <div class="setting">
          <div class="description">Preview Keys</div>
          <input class="hidden" id="preview-keys" name="preview-keys" type="checkbox">
          <label for="preview-keys" class="switch"><div class="round"></div></label>
        </div>

        <div class="setting">
          <div class="description">Sound</div>
          <input class="hidden" id="sound" name="sound" type="checkbox">
          <label for="sound" class="switch"><div class="round"></div></label>
        </div>

        <div class="setting">
          <div class="description">Font Size</div>
          <div class="incrementer">
            <input id="minus-button" class="left" type="button" value="-">
            <input id="plus-button" class="right" type="button" value="+">
          </div>
        </div>

        <input id="reset-button" name="reset-button" value="Reset &amp; Clear Stored Data" type="button">
      </div>
      <img class="icon" src="flower-icon.png"/>
    </aside>

    <aside id="aside-right" class="right">
      <div class="inner">

        <div id="nameless">
          <div class="legend">
            <img src="hand.gif"/>
            <div class="thumb">t</div>
            <div class="index">i</div>
            <div class="middle">m</div>
            <div class="ring">r</div>
            <div class="pinkie">p</div>
          </div>
          <div class="info" />This is where some additional info could go... and possibly a hide legend button.
          </div>
        </div>

        <div id="chords">
          <div class="header">
            <span class="c">CHORD</span>
            <span class="l">LTR</span>
            <span class="s">NUM</span>
            <span class="b">BKT</span>
            <span class="n">SYM</span>
          </div>

          <div id="chord r">
            <span class="c">r</span>
            <span class="l">A</span>
            <span class="s">;</span>
            <span class="b">/</span>
            <span class="n">2</span>
          </div>

          <div id="chord-pr">
            <span class="c">p&#x00B7;r</span>
            <span class="l">B</span>
            <span class="s">@</span>
            <span class="b">|</span>
            <span class="n">4</span>
          </div>

          <div id="chord-pt">
            <span class="c">p&#x00B7;t</span>
            <span class="l">C</span>
            <span class="s">_</span>
            <span class="b"></span>
            <span class="n"></span>
          </div>

          <div id="chord-it">
            <span class="c">i&#x00B7;t</span>
            <span class="l">D</span>
            <span class="s">=</span>
            <span class="b">{</span>
            <span class="n"></span>
          </div>

          <div id="chord-i">
            <span class="c">i</span>
            <span class="l">E</span>
            <span class="s">!</span>
            <span class="b">)</span>
            <span class="n">0</span>
          </div>

          <div id="chord-ir">
            <span class="c">i&#x00B7;r</span>
            <span class="l">F</span>
            <span class="s">$</span>
            <span class="b"></span>
            <span class="n"></span>
          </div>

          <div id="chord-tm">
            <span class="c">t&#x00B7;m</span>
            <span class="l">G</span>
            <span class="s"></span>
            <span class="b">&gt;</span>
            <span class="n"></span>
          </div>

          <div id="chord-rt">
            <span class="c">r&#x00B7;t</span>
            <span class="l">H</span>
            <span class="s">-</span>
            <span class="b"></span>
            <span class="n"></span>
          </div>

          <div id="chord-mi">
            <span class="c">m&#x00B7;i</span>
            <span class="l">I</span>
            <span class="s">*</span>
            <span class="b">[</span>
            <span class="n">6</span>
          </div>

          <div id="chord-mit">
            <span class="c">m&#x00B7;i&#x00B7;t</span>
            <span class="l">J</span>
            <span class="s"></span>
            <span class="b"></span>
            <span class="n"></span>
          </div>

          <div id="chord-ip">
            <span class="c">i&#x00B7;p</span>
            <span class="l">K</span>
            <span class="s">~</span>
            <span class="b"></span>
            <span class="n"></span>
          </div>

          <div id="chord-im">
            <span class="c">i&#x00B7;m</span>
            <span class="l">L</span>
            <span class="s">^</span>
            <span class="b">]</span>
            <span class="n"></span>
          </div>

          <div id="chord-pm">
            <span class="c">p&#x00B7;m</span>
            <span class="l">M</span>
            <span class="s">&amp;</span>
            <span class="b"></span>
            <span class="n">7</span>
          </div>

          <div id="chord-rm">
            <span class="c">r&#x00B7;m</span>
            <span class="l">N</span>
            <span class="s">:</span>
            <span class="b"></span>
            <span class="n">5</span>
          </div>

          <div id="chord-p">
            <span class="c">p</span>
            <span class="l">O</span>
            <span class="s">"</span>
            <span class="b">/</span>
            <span class="n">3</span>
          </div>

          <div id="chord-mr">
            <span class="c">m&#x00B7;r</span>
            <span class="l">P</span>
            <span class="s">%</span>
            <span class="b"></span>
            <span class="n"></span>
          </div>

          <div id="chord-mp">
            <span class="c">m&#x00B7;p</span>
            <span class="l">Q</span>
            <span class="s">`</span>
            <span class="b"></span>
            <span class="n"></span>
          </div>

          <div id="chord-mt">
            <span class="c">m&#x00B7;t</span>
            <span class="l">R</span>
            <span class="s">+</span>
            <span class="b">&lt;</span>
            <span class="n"></span>
          </div>

          <div id="chord-ri">
            <span class="c">r&#x00B7;i</span>
            <span class="l">S</span>
            <span class="s"></span>
            <span class="b"></span>
            <span class="n">8</span>
          </div>

          <div id="chord-m">
            <span class="c">m</span>
            <span class="l">T</span>
            <span class="s">?</span>
            <span class="b">(</span>
            <span class="n">1</span>
          </div>

          <div id="chord-pi">
            <span class="c">p&#x00B7;i</span>
            <span class="l">U</span>
            <span class="s">#</span>
            <span class="b"></span>
            <span class="n">9</span>
          </div>

          <div id="chord-tp">
            <span class="c">t&#x00B7;p</span>
            <span class="l">V</span>
            <span class="s"></span>
            <span class="b"></span>
            <span class="n"></span>
          </div>

          <div id="chord-ti">
            <span class="c">t&#x00B7;i</span>
            <span class="l">W</span>
            <span class="s"></span>
            <span class="b">}</span>
            <span class="n"></span>
          </div>

          <div id="chord-rmt">
            <span class="c">r&#x00B7;m&#x00B7;t</span>
            <span class="l">X</span>
            <span class="s"></span>
            <span class="b"></span>
            <span class="n"></span>
          </div>

          <div id="chord-tr">
            <span class="c">t&#x00B7;r</span>
            <span class="l">Y</span>
            <span class="s"></span>
            <span class="b"></span>
            <span class="n"></span>
          </div>
          
          <div id="chord-rp">
            <span class="c">r&#x00B7;p</span>
            <span class="l">Z</span>
            <span class="s"></span>
            <span class="b"></span>
            <span class="n"></span>
          </div>

          <div id="chord-t">
            <span class="c">t</span>
            <span class="l">&#x2423;</span>
            <span class="s">'</span>
            <span class="b"></span>
            <span class="n"></span>
          </div>

          <div id="chord-prm">
            <span class="c">p&#x00B7;r&#x00B7;m</span>
            <span class="l">.</span>
            <span class="s"></span>
            <span class="b"></span>
            <span class="n"></span>
          </div>

          <div id="chord-rmi">
            <span class="c">r&#x00B7;m&#x00B7;i</span>
            <span class="l">,</span>
            <span class="s"></span>
            <span class="b"></span>
            <span class="n"></span>
          </div>
        </div> <!-- chords -->

        <span class="icon">&#9835;</span>
        <!-- <img class="icon" src="flower-icon.png"/> -->
      </div>
      <!-- <span style="color:#fff">
        keep visible
      </span> -->
    </aside>

    <footer>
      <a href="" id="chordak"><div>CHORDAK</div></a>

      <a href="" class="menu"><div>info</div></a>
      <a href="" class="menu"><div>order</div></a>
      <a href="" class="menu"><div>forum</div></a>
      <a href="" class="menu"><div>help</div></a>
    </footer>
    <!-- <div>site design &copy;2017</div> -->

    <audio id="mistake-sound">
      <source src="sounds/mistake.wav" type="audio/wav">
    </audio>

    <script>

      /* utility functions ------------------------------------ */

      function $(s) { 
        if (s[0] == '.') {
          return document.getElementsByClassName(s.substr(1));
        }
        return document.getElementById(s);
      }

      function htmlDecode(input){
        var e = document.createElement('div');
        e.innerHTML = input;
        return e.childNodes[0].nodeValue;
      }

      function o(output) {
        $('output').innerHTML = output;
      }

      /* reflow lesson text on resize ------------------------- */

      function debounceResize(e) {
        resizeKeyboard();

        const newPaperWidth = $('paper').clientWidth;
        if (newPaperWidth != paperWidth) {
          //only runs if width of writing area has changed
          window.clearTimeout(resizeTimeout);
          resizeTimeout = window.setTimeout(reflowText, 200);
          paperWidth = newPaperWidth;
          //keep for debugging of resize function
          //$('paper').style.backgroundColor = 'red';
        }
      }

      function resizeKeyboard() {
        const w = document.body.clientWidth;
        const h = document.body.clientHeight;
        const s = (w < h) ? w-50 : h-200

        const limit = (w < h) ? 480 : 320;
        var size = (s > limit) ? 5.4 : (5.4 / limit) * s;
        var suffix = 'rem';
        document.documentElement.style.setProperty('--key', size+suffix);
        // $('chordak').innerHTML = size;
        var w0 = document.body.clientWidth;
        var h0 = document.body.clientHeight;
        $('chordak').innerHTML = w0 + ', ' + h0 + ', ' + size;
        // o(w);
        // alert(w);
      }

      /* reflow text ---------------------------------------------- */

      function reflowText() {
        var wordNumber = 0;
        var lineNumber = 0;
        var lineUsage = 0;
        const lineCapacity = measureLineCapacity();

        lineStartsAt = []; //resets
        lineStartsAt[0] = 0;
        for (var g = 0; g < glyphs.length; g++) {
          var carriageReturn = false;
          lineUsage++;
          if (lineUsage == lineCapacity) { 
            // sets flag if the line is full
            carriageReturn = true; 
          } else if (glyphs[g] == '⏎') { 
            // sets flag if the glyph is a carriage return
            carriageReturn = true; 
          } else if (glyphs[g] == '&nbsp;') {
            // sets flag if next word won't fit on line
            // (but only if the word can fit on a line)
            wordNumber++;
            var nextWordLength = wordLengths[wordNumber];
            var fit = nextWordLength <= (lineCapacity - lineUsage);
            var fitsOnNextLine = nextWordLength <= lineCapacity;
            // alert(nextWordLength + ", " + fit + ", " + fitsOnNextLine);
            if (!fit && fitsOnNextLine) { carriageReturn = true }
          }

          if (carriageReturn == true) {
            lineStartsAt.push(g+1);
            lineNumber++;
            lineUsage = 0;
          }
        }

        renderLines();
        //keep for debugging of resize function
        //$('paper').style.backgroundColor = 'green';
      }


      function renderLines() {
        //NOTE currentLine SHOULD BE COMPUTED FROM CARET
        var currentLine = 0;
        var start = (currentLine == 0) ? 0 : (currentLine - 1);
        //var limit = (currentLine == 0) ? (currentLine + 3) : (currentLine + 2);
        start = 0;
        var limit = 3;

        $('paper').children[0].innerHTML = '';
        $('paper').children[1].innerHTML = '';
        $('paper').children[2].innerHTML = '';
        // $('chordak').innerHTML += ', ' + lineStartsAt[0] + ' ' + lineStartsAt[1] + ' ' + lineStartsAt[2];
        
        //concatenate the spans and replace lines on paper
        for (var i = start; i < limit; i++) {
          var innerHTML = '';

          if (g >= glyphs.length) {
            innerHTML = 'empty line';
          } else {
            var g = lineStartsAt[i]
            var max = (lineStartsAt.length > i+1) ? lineStartsAt[i+1] : (glyphs.length);
            while(g < max) {
              if (htmlSpans[g] == '') { alert('span fail'); }
              innerHTML += htmlSpans[g];
              g++;
            }
          }

          $('paper').children[i].innerHTML = innerHTML;
        }
      }


      function measureLineCapacity() {
        const lineWidth = $('paper').children[0].clientWidth;
        const fontSizeString = window.getComputedStyle($('paper')).getPropertyValue("font-size");
        const fontSize = Number(fontSizeString.slice(0,fontSizeString.length-2));
        const capacity = Math.floor(lineWidth / (10.25 * fontSize/17));
        // $('chordak').innerHTML = lineWidth + ' ' + capacity;
        return capacity
      }

      /* lessons ---------------------------------------------- */

      var lessons = []; 
      lessons[0] = "-===10===--===20===--===30===--===40===--===50===--===60===--===70===--===80===--===90===-";

      lessons[1] = 'The quick brown fox jumps over the lazy dog.⏎' +
                   'Aa Bb Cc Dd Ee Ff Gg Hh Ii Jj Kk Ll Mm Nn Oo Pp Qq Rr Ss Tt Uu Vv Ww Xx Yy Zz 0123456789';

      lessons[2] = 'The quick brown fox⏎jumps over the lazy dog. This line should be long enough to wrap onto the following line without manual carriage return...';

      lessons[3] = 'you might be one of those people that perform';

      lessons[4] = 'the quick brown fox jumps over the lazy dog';

      var caret;
      var glyphs = [];
      var cssClasses = [];
      var htmlSpans = [];
      var wordLengths = [];
      var lineStartsAt = []; //contains index of glyphs that start lines

      loadLesson(4);

      function loadLesson(n) {
        //reset the lesson state
        caret = 0;
        glyphs = [];
        htmlSpans = [];
        cssClasses = [];
        wordLengths = [];
        
        var lesson = lessons[n];
        var wordLength = 0;
        for (var g = 0; g < lesson.length; g++) {
          glyphs[g] = (lesson[g] == ' ') ? '&nbsp;' : lesson[g];
          cssClasses[g] = ''; //initialize the class for each glyph
          htmlSpans[g] = glyphs[g];

          /* computes and stores the length of each word includes trailing space and CR symbol to avoid starting a line with a space or CR */
          wordLength++;
          if (glyphs[g] == '&nbsp;') { 
            wordLengths.push(wordLength)
            wordLength = 0;
          } else if (glyphs[g] == '⏎') { 
            wordLengths.push(wordLength + 1);
            wordLength = 0;
          }
        }

        //needed because above loop doesn't include last word length
        if(wordLength != 0) { wordLengths.push(wordLength); }

        reflowText();
      }


      function changeState() {
                /*
        cssClasses[15] = 'm';

        for (var i = 0; i < glyphs.length; i++) {

          var open = '<span class="' + cssClasses[i] + '">';
          var glyph = glyphs[i];
          var close = '</span>';
          
          if(glyph == ' ') {
            breaks.push(i);
            //special case for mistake on space (note: ␣ is U+2423)
            if (cssClasses[i] == 'm') { glyph = '␣'; }
          }
          //concatenate the tags to produce the finished span
          spans[i] = open + glyph + close;
          if (i > 13 && i < 16) { alert(spans[i]); } 
        }
        */
      }


      /* asides ----------------------------------------------- */
      
      function toggleAside(e) {
        // if no aside is open, go ahead and open one now
        if (asideOpen == null) {
          asideOpen = e.currentTarget;
          asideOpen.classList.add('open');
          e.stopPropagation(); // may be unnecessay
          document.body.style.cursor = 'pointer';
          //add a click listener to the window to close the aside
          window.addEventListener('click', toggleAside);
          if (asideOpen.id == 'aside-left') { 
            disableKeyboard();
          }
        // if an aside is open, closes on click out of aside
        } else if (!asideOpen.contains(e.target)) {
          close(e);
        }
      }

      function close(e) {
        e.stopPropagation();
        if (asideOpen.id == 'aside-left') { 
          enableKeyboard();
        }
        document.body.style.cursor = 'auto';
        asideOpen.classList.remove('open');
        
        asideOpen = null;
        //aside is closed so remove the listener from the window
        window.removeEventListener('click', toggleAside);
      }

      function tester(argument) {
        alert('works');
      }

      function enableKeyboard() {
        window.addEventListener("keydown", keydown);
        window.addEventListener("keyup", keyup);
      }

      function disableKeyboard() {
        window.removeEventListener("keydown", keydown);
        window.removeEventListener("keyup", keyup);
      }

      /* settings ----------------------------------- */

      function setHand(e) {
        const checked = $('typing-hand').checked;
        const keyboard = $('keyboard');
        const customLayout = $('custom-layout');

        const [remove, add] = checked ? ['L', 'R'] : ['R', 'L'];
        keyboard.classList.remove(remove);
        keyboard.classList.add(add);
        customLayout.classList.remove(remove);
        customLayout.classList.add(add);

        hand = checked ? 'R' : 'L';
        localStorage.hand = hand;
        $('typing-hand-label').innerHTML = hand;

        setLayout();
      }

      /* typing analysis  ------------------------------------- */

      // var speed = document.getElementById("speed");
      // var timer = document.getElementById("timer");

      /* keyboard input --------------------------------------- */

      var chordsRaw = {};
      //for any chord that isn't defined below, send the modifier keys first then the letter, numeral, or symbol afterwards

      // layout keys
      chordsRaw['escape'] = 'escape';         //p0
      chordsRaw['pinkie'] = 'o';              //p1
      chordsRaw['return'] = 'return';         //p2
      
      chordsRaw['alt'] = 'alt';               //r0
      chordsRaw['ring'] = 'a';                //r1
      chordsRaw['tab'] = 'tab';               //r2

      chordsRaw['meta'] = 'meta';             //m0
      chordsRaw['middle'] = 't';              //m1
      chordsRaw['delete'] = 'delete';         //m2

      chordsRaw['control'] = 'control';       //i0
      chordsRaw['index'] = 'e';               //i1
      chordsRaw['shift'] = 'shift';           //i2

      chordsRaw['navigation'] = 'navigation'; //t0
      chordsRaw['thumb'] = 'space';           //t1
      chordsRaw['symbol'] = 'symbol';         //t2
      chordsRaw['numeral'] = 'numeral';       //t3

      // home key chords
        // 'a' is above in layout keys
      chordsRaw['pinkie ring'] = 'b';
      chordsRaw['pinkie thumb'] = 'c';
      chordsRaw['index thumb'] = 'd';
        // 'e' is above in layout keys
      chordsRaw['index ring'] = 'f';
      chordsRaw['thumb middle'] = 'g';
      chordsRaw['ring thumb'] = 'h';
      chordsRaw['middle index'] = 'i';
      chordsRaw['middle index thumb'] = 'j';
      chordsRaw['index pinkie'] = 'k';
      chordsRaw['index middle'] = 'l';
      chordsRaw['pinkie middle'] = 'm';
      chordsRaw['ring middle'] = 'n';
        // 'o' is above in layout keys
      chordsRaw['middle ring'] = 'p';
      chordsRaw['middle pinkie'] = 'q';
      chordsRaw['middle thumb'] = 'r';
      chordsRaw['ring index'] = 's';
        // 't' is above in layout keys
      chordsRaw['pinkie index'] = 'u';
      chordsRaw['thumb pinkie'] = 'v';
      chordsRaw['thumb index'] = 'w';
      chordsRaw['ring middle thumb'] = 'x';
      chordsRaw['thumb ring'] = 'y';
      chordsRaw['ring pinkie'] = 'z';

      chordsRaw['pinkie ring middle'] = ',';
      chordsRaw['ring middle index'] = '.';
      chordsRaw['pinkie ring middle index'] = 'return';
      
      //shifted keys
      chordsRaw['shift pinkie'] = 'O';
      chordsRaw['shift ring'] = 'A';
      chordsRaw['shift middle'] = 'T';
      chordsRaw['shift index'] = 'E';

      chordsRaw['shift pinkie middle'] = 'M';


      var tree = [];
      var node = 0;
      // var ccc = 0;
      function buildTree() {
        var countCreated = 0;
        var countTotal = 0;
        
        //create a node for each chord
        tree.push({ chord:'root', children:[] });

        for (var chord in chordsRaw) {
          if (chordsRaw.hasOwnProperty(chord)) {
            var child = undefined;
            //loop through each partial chord to create
            //nodes and add children indicies as needed
            var notes = chord.split(' ');
            var partialLength = notes.length;
            while(partialLength >= 0) {
              //assembles the partial chord name
              var partialChord = '';
              var j = partialLength;
              while(j > 0) {
                j--;
                partialChord = ' ' + notes[j] + partialChord;
              }
              partialChord = 'root' + partialChord;
              partialLength--;

              //checkes if the node already exists
              var k = tree.length;
              while(k > -1) {
                k--;
                //break loop if index falls below 0
                if (k < 0) { break; }
                //break loop if partial chord is already in tree
                if(tree[k].chord == partialChord) { break; }
              }

              //creates a node if it doesn't exist
              countTotal++;
              if (k == -1) {
                countCreated++;
                node++;
                tree.push({ chord:partialChord, 
                            children:[] });
                var rawChord = partialChord.substr(5);
                if (chordsRaw[rawChord] != undefined) {
                  tree[node].output = chordsRaw[rawChord];
                }
                k = node;
              }

              //assigns child node
              if (child != undefined) {
                if(tree[k].children.indexOf(child) == -1) {
                  tree[k].children.push(child);
                }
              }
              child = k;
            }
          }
        }

        // $('output').innerHTML = '';
        // for (var n in tree) {
        //  if (tree.hasOwnProperty(n)) {
        //    $('output').innerHTML +=
        //    n + ', ' +
        //    tree[n].chord + ', ' +
        //    tree[n].output + ', ' +
        //    tree[n].children + '<br>';
        //  }
        // }

        //reset the node index to the root node
        node = 0;
      }

      
      var raw = '';
      var pressed = [];
      var count = 0;
      var writing = '';

      // var start = 0;

      var repeatCount = 0;
      var keydownCount = 0;

      var keyboardEnabled = true;

      var startTime = 0;
      var speedTimeout;

      function timeoutHandler() {
        var elapsed = (Date.now() - startTime) / 1000;
        var error = elapsed - Math.floor(elapsed);
        error = Math.floor(error * 1000);
        timer.innerHTML = Math.floor(elapsed);
        if (elapsed < 60) {
          speedTimeout = window.setTimeout(timeoutHandler, 1000-error);
        }
      }
      
      function traverse(keyCode) {
        const chord = tree[node].chord + ' ' + keyCodeToName[keyCode];

        var i = tree[node].children.length;
        var moved = false;
        var recur = true;
        // checks if the pressed chord is a child of the node
        while(i > 0) {
          i--;
          const child = tree[node].children[i];
          if (tree[child].chord == chord) {
            node = child;
            moved = true;
            break;
          }
          // chord isn't defined, but key is in the layout
            // treat the preceeding chord as a good entry
            // (possibly) show an error message to the user
          if(i == 0 && moved == false) {
            recur = false;
          }
        }

        if (moved) {
          //no further branches in tree
            //output the current node value immediately
          if(tree[node].children.length == 0) {
            $('output').innerHTML += tree[node].output; //temp
            node = 0;
          }
        } else {
          //didn't move in the tree so output at the current node
          $('output').innerHTML += tree[node].output; //temp
          node = 0;

          // traverse again from root if final key is in layout
          if (recur) { traverse(keyCode); }
        }
      }

      var pressed = [];
      var released = [];

      /* Since the keyboard behavior is mostly the same during the different modes, one pair of keyup/keydown functions will handle typing for each mode with conditionals as needed. */
      function keydown(e) {
        if (!keyboardEnabled) { return; }
        hideKeyCaps(); //consider adding setting to disable autohide
        e.preventDefault();

        // ignore the keypress if the key is being held down
        if(e.repeat == true) { return; }

        // start the timer if...
        // if(caret == 0) { timer('start'); }

        const keyCode = e.which;

        // if the key pressed isn't part of the layout,
        // show a warning message and ignore the keypress
        if(!keyCodeToName[keyCode]) {
          window.clearTimeout(warningTimeout);
          $('warning').innerHTML = 'the ' + keyCodeToLabel(keyCode) + ' key isn\'t part of the layout';
          $('warning').style.transition = 'none';
          $('warning').style.opacity = 1;
          warningTimeout = window.setTimeout(hideWarning, 1000);
           // + keyCodeToLabel(keyCode) + ' isn\'t part of the layout');
          return;
        }

        // tracks the sequence and # of key pressed
        pressed.push(keyCode);

        traverse(keyCode);
      }

      var warningTimeout;
      function hideWarning() {
        $('warning').style.transition = 'opacity 400ms ease';
        $('warning').style.opacity = 0;
        // $('warning').innerHTML = '';
      }


      function keyup(e) {
        if (!keyboardEnabled) { return; }
        e.preventDefault();

        const keyCode = e.which;

        //released key wasn't counted as pressed so don't count it as released and return immediately 
        if(pressed.indexOf(keyCode) == -1) { return; }
        released.push(keyCode);

        // all the pressed keys have been released
          // simple case where all keys were released
          // NOTE: will also eventually need to handle cmd key and other interruptions like changing tabs while pressed
        if(node != 0 && pressed.length == released.length) {
          $('output').innerHTML += tree[node].output; //temp
          node = 0;
        }

        /*
        if (count == 0) {
          if (chords[raw]) qv{
            var glyph = glyphs[caret];

            var letter = chords[raw];
            if(letter == glyphs[caret]) {
              cssClasses[caret] = 'c';
            } else {
              cssClasses[caret] = 'm';
              if (glyph == '&nbsp;') {
                glyph = '␣';
              }
              
              mistakeSound.pause();
              mistakeSound.currentTime = 0;
              mistakeSound.play();
            }

            var open = '<span class="' + cssClasses[caret] + '">';
            var close = '</span>';
            htmlSpans[caret] = open + glyph + close;

            caret++;

            if(caret < glyphs.length) {
              //only advance the caret when lesson isn't over
              cssClasses[caret] = 'caret';
              var open = '<span class="' + cssClasses[caret] + '">';
              var glyph = glyphs[caret];
              var close = '</span>';
              htmlSpans[caret] = open + glyph + close;
            } else {
              timer('stop');
              keyboardEnabled = false;
            }
          } else {
            //take action here if undefined keys are pressed
            //perhaps show the incorrect chord below in yellow
            //undefinedSound.pause();
            //undefinedSound.currentTime = 0;
            //undefinedSound.play();

            cssClasses[caret] = 'undefined';
              var open = '<span class="' + cssClasses[caret] + '">';
              var glyph = glyphs[caret];
              var close = '</span>';
              htmlSpans[caret] = open + glyph + close;
          }
          renderLines();
          raw = '';
        }
        */

        /*
        // if (count == 0) {
        //  var letter = chords[raw];
        //  $('chordak').innerHTML += (' = ' + letter);
        //  raw = '';
        // }

        // used to do erase
        // //special case for caps lock being turned off
        // if (key == 20) {
        //  e.preventDefault();
        //  writing = writing.slice(0, writing.length-1);
        //  practice.innerHTML = writing;
        //  // x.innerHTML = "<small>&#9003;</small>";
        //  // x2.innerHTML = "backspace";
        // }

        // if (count == 0) {
        //  if(chords[raw]) {
        //    // x.innerHTML = raw;
        //    // x2.innerHTML = chords[raw];
        //    //writing += raw + "_"; //use for getting raw output
        //    writing += chords[raw].toLowerCase();
        //    practice.innerHTML = writing;
        //  } else {
        //    if (key != 8 || key != 20) {
        //      // x2.innerHTML = "unassigned";
        //    }
            
        //  }
        //  raw = "";

        //  if(start != 0 && writing == test) {
        //    window.clearTimeout(speedTimeout);
        //    var elapsed = Date.now() - start; //ms
        //    var seconds = Math.round(elapsed / 100) / 10;
        //    var wpm = (test.length / 5) / (elapsed / 1000 / 60);
        //    wpm = Math.round(wpm * 10) / 10;

        //    //speed.innerHTML = wpm.toFixed(1);
        //    //timer.innerHTML = seconds.toFixed(1);

        //    start = 0;
        //    writing = "";
        //  }
        */
      }

      function timer(action) {
        if (action == 'start') {
          startTime = Date.now();
          speedTimeout = window.setTimeout(timeoutHandler, 1000);
          // timer.innerHTML = '0';
          $('chordak').innerHTML = '- wpm';
        } else if (action == 'stop') {
            window.clearTimeout(speedTimeout);
            var elapsed = Date.now() - startTime; //ms
            var seconds = Math.round(elapsed / 100) / 10;
            var wpm = (glyphs.length / 5) / (elapsed / 1000 / 60);
            wpm = Math.round(wpm * 10) / 10;

            $('chordak').innerHTML = wpm + ' wpm';
            //writing = "";
        }
      }

      /* keyboard layout -------------------------------------- */

      // letter: pinkie, ring, middle, index, thumb
      // number: amount of finger flexion, 0 is minimum flexion

      var p0 = {
        name:'escape',
        keycap: {chordak:'ESC', physical:'?'}
      };
      var p1 = {
        name:'pinkie',
        keycap: {chordak:'PINKIE', physical:'?'}
      };
      var p2 = {
        name:'return',
        keycap: {chordak:'RETURN', physical:'?'}
      };

      var r0 = {
        name:'alt',
        keycap: {chordak:'ALT', physical:'?'},
        dead_key:true
      };
      var r1 = {
        name:'ring',
        keycap: {chordak:'RING', physical:'?'}
      };
      var r2 = {
        name:'tab',
        keycap: {chordak:'TAB', physical:'?'}
      };

      var m0 = {
        name:'meta',
        keycap: {chordak:'META', physical:'?'},
        dead_key:true
      };
      var m1 = {
        name:'middle',
        keycap: {chordak:'MIDDLE', physical:'?'}
      };
      var m2 = {
        name:'delete',
        keycap: {chordak:'DELETE', physical:'?'}
      };

      var i0 = {
        name:'control',
        keycap: {chordak:'CTRL', physical:'?'},
        dead_key:true
      };
      var i1 = {
        name:'index',
        keycap: {chordak:'INDEX', physical:'?'}
      };
      var i2 = {
        name:'shift',
        keycap: {chordak:'SHIFT', physical:'?'},
        dead_key:true,
        locks:true
      };

      var t0 = {
        name:'navigation',
        keycap: {chordak:'NAV', physical:'?'},
        dead_key:true,
        locks:true
      };
      var t1 = {
        name:'thumb',
        keycap: {chordak:'THUMB', physical:'?'}
      };
      var t2 = {
        name:'symbol',
        keycap: {chordak:'SYM', physical:'?'},
        dead_key:true
      };
      var t3 = {
        name:'numeral',
        keycap: {chordak:'FN<br>NUM', physical:'?'},
        dead_key:true,
        locks:true
      };

      var keyCodeToName = [];

      var keyboard = { p0:p0, p1:p1, p2:p2,
                       r0:r0, r1:r1, r2:r2,
                       m0:m0, m1:m1, m2:m2,
                       i0:i0, i1:i1, i2:i2,
                       t0:t0, t1:t1, t2:t2, t3:t3 };

      var layouts = { qwerty:{}, colemak:{}, dvorak:{}, custom:{} };

      layouts.qwerty = { L:{ p0:00, p1:08, p2:00,
                             r0:00, r1:00, r2:00,
                             m0:00, m1:00, m2:00,
                             i0:00, i1:00, i2:00,
                             t0:00, t1:00, t2:00, t3:00 },
                         R:{ p0:00, p1:00, p2:00,
                             r0:00, r1:00, r2:00,
                             m0:00, m1:00, m2:00,
                             i0:00, i1:00, i2:00,
                             t0:00, t1:00, t2:00, t3:00 } };

      layouts.colemak = {L:{ p0:09, p1:08, p2:16,
                             r0:49, r1:81, r2:65,
                             m0:50, m1:87, m2:82,
                             i0:51, i1:70, i2:83,
                             t0:66, t1:86, t2:67, t3:88 },
                         R:{ p0:189,p1:219,p2:222,
                             r0:48, r1:186,r2:79,
                             m0:57, m1:89, m2:73,
                             i0:56, i1:85, i2:69,
                             t0:66, t1:75, t2:77, t3:188 } };

      layouts.dvorak = { L:{ p0:00, p1:00, p2:00,
                             r0:00, r1:00, r2:00,
                             m0:00, m1:00, m2:00,
                             i0:00, i1:00, i2:00,
                             t0:00, t1:00, t2:00, t3:00 },
                         R:{ p0:00, p1:00, p2:00,
                             r0:00, r1:00, r2:00,
                             m0:00, m1:00, m2:00,
                             i0:00, i1:00, i2:00,
                             t0:00, t1:00, t2:00, t3:00 } };

      layouts.custom = { L:{ p0: 9, p1:20, p2:16,
                             r0:49, r1:81, r2:65,
                             m0:50, m1:87, m2:83,
                             i0:51, i1:69, i2:68,
                             t0:66, t1:86, t2:67, t3:88 },
                         R:{ p0:-1, p1:-1, p2:-1,
                             r0:-1, r1:-1, r2:-1,
                             m0:-1, m1:-1, m2:-1,
                             i0:-1, i1:-1, i2:-1,
                             t0:-1, t1:-1, t2:-1, t3:-1 } };


      function setLayout() {
        const layout = $('layout').value
        localStorage.layout = layout;
        var hand = $('typing-hand').checked ? 'R' : 'L';

        //special handling for a custom keyboard layout
        var display = (layout == 'custom') ? 'block' : 'none';
        $('custom-layout').style.display = display;

        //loop through the chosen layout and assign it to the keys map
        for (var key in keyboard) {
            if (keyboard.hasOwnProperty(key)) {
                const keyCode = layouts[layout][hand][key];
                keyCodeToName[keyCode] = keyboard[key].name;
                keyboard[key].keycap.physical = keyCodeToLabel(keyCode,'keycap');
            }
        }
      }

      var selectedKey;
      var editTimeout;
      var editFlag = false;

      function editLayoutCheck(e) {
        editFlag = false;

        if(localStorage.layout != 'custom') { return; }
        if(keycaps != 'physical') { return; }

        //return early if the click wasn't on a key
        o(e.target.id);
        if(!e.target.classList.contains('key')) { 
          selectedKey = undefined;
          return; 
        }
        // e.stopPropagation(); //may not be needed

        // o('editing: waiting for timeout');
        window.clearTimeout(editTimeout);
        editTimeout = window.setTimeout(editStartListening, 160);
        selectedKey = e.target;
      }

      function editStartListening() {
        editFlag = true;
        // o('editing: listening for keypress');
        window.addEventListener("keydown", editLayout);
        keyboardEnabled = false;
        selectedKey.classList.add('editing');
      }

      function printCustomLayout() {
        var hand = $('typing-hand').checked ? 'R' : 'L';
        var str = hand + ':{ ';
        var n = 0;
        for (var key in layouts.custom[hand]) {
          if (layouts.custom[hand].hasOwnProperty(key)) {
            str += key + ':'
            str += layouts.custom[hand][key];
            if (n != 15) {
              str += ', ';
            }
            if (n == 2 || n == 5 || n == 8 || n == 11) {
              str += '<br>';
            }
          }
          n++;
        }
        str += ' }';
        o(str);
      }

      function editLayout(e) {
        e.preventDefault();
        var keyCode = e.which;
        var key = selectedKey.id;
        localStorage.setItem(key+'-'+hand, keyCode);

        loadCustomLayout();
        setLayout();
        updateKeyCaps();

        printCustomLayout();
        return;
      }

      function keyCodeToLabel(keyCode, type = 'name') {
        var kctl = [];
        kctl[8] = { name:'DELETE' };
        kctl[9] = { name:'TAB' };
        kctl[13] = { name:'RETURN' };
        kctl[16] = { name:'SHIFT' };;
        kctl[17] = { name:'CONTROL', keycap:'CTRL' };
        kctl[18] = { name:'ALT' };
        kctl[27] = { name:'ESCAPE', keycap:'ESC' };     
        kctl[91] = { name:'COMMAND/WINDOWS', keycap:'CMD' };
        kctl[93] = { name:'COMMAND RIGHT', keycap:'CMD' }
        kctl[32] = { name:'SPACE' };
        kctl[20] = { name:'CAPS LOCK', keycap:'CAPS<BR>LOCK' };
        kctl[37] = { name:'LEFT ARROW', keycap:'◀' };
        kctl[38] = { name:'UP ARROW', keycap:'▲' };
        kctl[39] = { name:'RIGHT ARROW', keycap:'▶' };
        kctl[40] = { name:'DOWN ARROW', keycap:'◀' };
        kctl[46] = { name:'FORWARD DELETE', keycap:'FWD<BR>DEL' };
        kctl[112] = { name:'F1' };
        kctl[113] = { name:'F2' };
        kctl[114] = { name:'F3' };
        kctl[115] = { name:'F4' };
        kctl[116] = { name:'F5' };
        kctl[117] = { name:'F6' };
        kctl[118] = { name:'F7' };
        kctl[119] = { name:'F8' };
        kctl[120] = { name:'F9' };
        kctl[121] = { name:'F10' };
        kctl[122] = { name:'F11' };
        kctl[123] = { name:'F12' };
        kctl[186] = { name:';',
        keycap:'<span class="stack">:<br>;</span>' };
        kctl[187] = { name:'=',
        keycap:'<span class="stack">+<br>=</span>' };
        kctl[188] = { name:',',
        keycap:'<span class="stack"><<br>,</span>' };
        kctl[189] = { name:'-',
        keycap:'<span class="stack">_<br>-</span>' };
        kctl[190] = { name:'.',
        keycap:'<span class="stack">><br>.</span>' };
        kctl[191] = { name:'/',
        keycap:'<span class="stack">?<br>/</span>' };
        kctl[192] = { name:'`',
        keycap:'<span class="stack">~<br>`</span>' };
        kctl[219] = { name:'[',
        keycap:'<span class="stack">{<br>[</span>' };
        kctl[220] = { name:'\\',
        keycap:'<span class="stack">|<br>\\</span>' };
        kctl[221] = { name:']',
        keycap:'<span class="stack">}<br>]</span>' };
        kctl[222] = { name:'\'',
        keycap:'<span class="stack">"<br>\'</span>' };

        if (kctl[keyCode]) {
          if (kctl[keyCode][type]) {
            return kctl[keyCode][type];
          } else {
            return kctl[keyCode]['name'];
          }
        } else if(keyCode >= 48 && keyCode <= 57) { // numerals
          return '<span>'+String.fromCharCode(keyCode)+'</span>';
        } else if(keyCode >= 65 && keyCode <= 90) { // letters
          return '<span>'+String.fromCharCode(keyCode)+'</span>';
        } else if(keyCode == -1) { // for custom layout
          return '';
        }
        return '<span>⧄</span>';
      }

      /* setup ------------------------------------------------ */

      //global state
      const mistakeSound = $('mistake-sound');
      mistakeSound.preload = true;
      var resizeTimeout;
      var paperWidth = $('paper').clientWidth;
      var asideOpen = null;
      var keycaps = 'off';

      function setup() {
        resizeKeyboard();
        initializeLocalStorage();
        loadCustomLayout();
        enableKeyboard();

        window.addEventListener('resize', debounceResize);

        $('aside-left').addEventListener('click', toggleAside);
        $('aside-right').addEventListener('click', toggleAside);

        $('keyboard').addEventListener('mousedown', editLayoutCheck);
        $('keyboard').addEventListener('mouseup', incrementKeycaps);
        
        //load settings from local storage or set to default
        const modeQuery = '#mode [value="' + 
        localStorage.mode + '"]';
        document.querySelector(modeQuery).selected = true;
        $('mode').addEventListener('change', setMode);

        const lessonQuery = '#lesson [value="' + 
        localStorage.lesson + '"]';
        document.querySelector(lessonQuery).selected = true;
        $('lesson').addEventListener('change', tester);
        
        $('typing-hand').checked = (localStorage.hand == 'R');
        $('typing-hand').addEventListener("change", setHand);

        const layoutQuery = '#layout [value="' + 
        localStorage.layout + '"]';
        document.querySelector(layoutQuery).selected = true;
        $('layout').addEventListener('change', setLayout);

        $('simulate').checked = localStorage.simulate;
        $('simulate').addEventListener('change', tester);

        $('show-keyboard').checked = localStorage.showKeyboard;
        $('show-keyboard').addEventListener('change', tester);

        $('preview-keys').checked = localStorage.previewKeys;
        $('preview-keys').addEventListener('change', tester);

        $('sound').checked = localStorage.sound;
        $('sound').addEventListener('change', tester);

        // font size
        $('minus-button').addEventListener('click', tester);
        $('plus-button').addEventListener('click', tester);

        $('close-button').addEventListener('click', close);
        $('reset-button').addEventListener('click', reset);

        setMode();
        setHand();

        buildTree();
      }

      setup();

      function initializeLocalStorage() {
        if(localStorage.mode == undefined) {
          localStorage.mode = 'training';
          localStorage.lesson = 0;
          localStorage.hand = 'L';
          localStorage.layout = 'qwerty';

          localStorage.simulate = true;
          localStorage.showKeyboard = true;
          localStorage.previewKeys = true;
          localStorage.sound = true;
          localStorage.fontSize = 17;
        }
      }

      function loadCustomLayout() {
        var hand = $('typing-hand').checked ? 'R' : 'L';

        for (var key in keyboard) {
          if (keyboard.hasOwnProperty(key)) {
            const keyCode = localStorage.getItem(key+'-'+hand);
            if(keyCode != undefined) {
              layouts.custom[hand][key] = keyCode;
            }
          }
        }
      }
      

      /* reset ------------------------------------------------ */
      function reset() {
        localStorage.clear();
        location.reload();
      }

      function setMode() {
        $('keyboard').classList.add('hidden');
        $('paper').classList.add('hidden');
        $('blank').classList.add('hidden');

        mode = $('mode').value;
        localStorage.mode = mode;
        switch (mode) {
          case 'training':
            $('keyboard').classList.remove('hidden');
            $('paper').classList.remove('hidden');
            break;
          case 'speed':
            $('paper').classList.remove('hidden');
            break;
          case 'blank':
            $('blank').classList.remove('hidden');
            break;
        }
      }

      // function keydownHandlerBlank(e) {
      //  if (!enabled) { return; }
      //  e.preventDefault();
      //  //ignore the event if the key is being held down
      //  if(e.repeat == true) { return; }
      //  var keyCode = e.which;

      //  if (keys[keyCode]) {
      //    raw += keys[keyCode];
      //    count++;
      //  }
      // }


      // function keyupHandlerBlank(e) {
      //  if (!enabled) { return; }
      //  e.preventDefault();
      //  var keyCode = e.which;
      //  if (keys[keyCode]) {
      //    count--;
      //  }
      //  if (count == 0) {
      //    if (chords[raw]) {
      //      var letter = chords[raw];
      //      if (letter == '&nbsp;') letter = ' ';
      //      insertAtCaret(letter);
      //    }
      //    raw = '';
      //  }
      // }
      // '\r\n'
      
      function insertAtCaret(letter) {
        var blank = $('blank');
        //var scrollSaved = blank.scrollTop;
        var caret = blank.selectionStart;

        var ante = blank.value.substr(0, blank.selectionStart);
        var post = blank.value.substr(blank.selectionEnd, blank.value.length);
        blank.value = ante + letter + post;
        
        blank.selectionStart = caret + 1;
        blank.selectionEnd = caret + 1;
        //blank.scrollTop = scrollSaved;
      }

      //var eCount = 0;
      function incrementKeycaps(e) {
        //eCount++;
        //o('editing: not editing ' + eCount);
        window.clearTimeout(editTimeout);
        //if(e.target != e.currentTarget) { return; }
        if (editFlag) {
          selectedKey.classList.remove('editing');
          window.removeEventListener("keydown", editLayout);
          editFlag = false;
          return;
        }

        switch (keycaps) {
          case 'off':      keycaps = 'chordak';  break;
          case 'chordak':  keycaps = 'physical'; break;
          case 'physical': keycaps = 'off';      break;
        }
        updateKeyCaps();
      }

      function hideKeyCaps() {
        if (keycaps != 'off') {
          keycaps = 'off';
          updateKeyCaps();
        }
      }

      function updateKeyCaps() {
        for (var key in keyboard) {
          if (keyboard.hasOwnProperty(key)) {
            $(key).innerHTML = (function () {
              switch (keycaps) {
                case 'off':      return '';
                case 'chordak':  return keyboard[key].keycap.chordak;
                case 'physical': return keyboard[key].keycap.physical;
              }
            })();
          }
        }
        $('keyboard-title').innerHTML = (function () {
          switch (keycaps) {
            case 'off':      return '';
            case 'chordak':  return 'chordak layout';
            case 'physical': return 'physical keys';
          }
        })();
      }
    </script>
  </body>
</html>